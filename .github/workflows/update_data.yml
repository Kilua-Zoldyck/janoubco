name: Update Products Data

on:
  schedule:
    # ÙŠØ´ØªØºÙ„ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª (0:00, 6:00, 12:00, 18:00 UTC)
    - cron: '0 */2 * * *'

  # ÙŠØ®Ù„ÙŠÙƒ ØªÙ‚Ø¯Ø± ØªØ´ØºÙ„Ù‡ ÙŠØ¯ÙˆÙŠ Ù…Ù† GitHub Actions tab
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install psycopg2-binary

      - name: Fetch data from Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        run: |
          python << 'EOF'
          import os
          import psycopg2
          import json
          from datetime import datetime
          from decimal import Decimal

          # Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Decimal Ùˆ datetime
          def json_serial(obj):
              if isinstance(obj, Decimal):
                  return float(obj)
              if isinstance(obj, datetime):
                  return obj.isoformat()
              raise TypeError(f"Type {type(obj)} not serializable")

          # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          conn = psycopg2.connect(os.getenv('SUPABASE_URL'))
          cur = conn.cursor()

          # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          query = """
              SELECT
                  name,
                  current_price,
                  category,
                  url,
                  last_updated,
                  CASE
                      WHEN is_deleted THEN 'Ù…Ø­Ø°ÙˆÙ'
                      WHEN is_out_of_stock THEN 'Ù†Ø§ÙØ¯'
                      WHEN is_hidden THEN 'Ù…Ø®ÙÙŠ'
                      ELSE 'Ù…ØªÙˆÙØ±'
                  END as status
              FROM products
              ORDER BY last_updated DESC NULLS LAST
          """

          cur.execute(query)
          rows = cur.fetchall()
          cols = [desc[0] for desc in cur.description]

          # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ JSON
          result = []
          for row in rows:
              product = {}
              for col, val in zip(cols, row):
                  if isinstance(val, Decimal):
                      product[col] = float(val)
                  elif isinstance(val, datetime):
                      product[col] = val.isoformat()
                  else:
                      product[col] = val
              result.append(product)

          # Ø­ÙØ¸ ÙÙŠ Ù…Ù„Ù JSON
          with open('products.json', 'w', encoding='utf-8') as f:
              json.dump(result, f, ensure_ascii=False, indent=2)

          # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          print(f"âœ… ØªÙ… Ø¬Ù„Ø¨ {len(result)} Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­")
          print(f"â° Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {datetime.now().isoformat()}")

          cur.close()
          conn.close()
          EOF

      - name: Commit and Push changes
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add products.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª - $(date +'%Y-%m-%d %H:%M')" && git push)
